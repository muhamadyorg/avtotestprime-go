{{define "title"}}Savolni tahrirlash - AvtotestPrime{{end}}

{{define "content"}}
<div class="page-header">
    <h1><i class="fas fa-edit"></i> Savolni tahrirlash #{{.QuestionData.Number}}</h1>
    <a href="/admin-panel/questions/" class="btn btn-outline">
        <i class="fas fa-arrow-left"></i> Orqaga
    </a>
</div>

<div class="form-card">
    <form method="post" action="/admin-panel/questions/{{.QuestionData.ID}}/edit/" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
        <div class="form-group">
            <label for="text">Savol matni:</label>
            <textarea id="text" name="text" rows="3" required>{{.QuestionData.Text}}</textarea>
        </div>
        <div class="form-group">
            <label for="image">Rasm:</label>
            {{if hasImage .QuestionData.Image}}
            <div class="current-image">
                <img src="{{imageURL .QuestionData.Image}}" alt="Hozirgi rasm" onclick="openImageModal('{{imageURL .QuestionData.Image}}')">
                <label class="checkbox-label">
                    <input type="checkbox" name="remove_image"> Rasmni o'chirish
                </label>
            </div>
            {{end}}
            <input type="file" id="image" name="image" accept="image/*">
        </div>

        <div class="variants-dynamic" id="variantsContainer">
            <div class="variants-header">
                <label class="form-label-main">Variantlar (2-10):</label>
                <button type="button" class="btn btn-sm btn-add-variant" onclick="addVariant()" id="btnAdd" title="Variant qo'shish">
                    <i class="fas fa-plus"></i> Qo'shish
                </button>
            </div>
            <div id="variantsList">
                {{range $i, $v := .QuestionData.VariantsList}}
                <div class="variant-row" data-index="{{$i}}">
                    <span class="variant-row-letter">{{$v.Letter}}</span>
                    <input type="text" name="variant_{{lower $v.Letter}}" value="{{$v.Text}}" required>
                    <button type="button" class="btn btn-sm btn-remove-variant variant-remove-btn" onclick="removeVariant(this)" title="Olib tashlash">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
                {{end}}
            </div>
        </div>

        <div class="form-group">
            <label for="correct_answer">To'g'ri javob:</label>
            <select id="correct_answer" name="correct_answer" required>
                {{range .QuestionData.VariantsList}}
                <option value="{{.Letter}}" {{if eq $.QuestionData.CorrectAnswer .Letter}}selected{{end}}>{{.Letter}}</option>
                {{end}}
            </select>
        </div>
        <button type="submit" class="btn btn-primary btn-full">
            <i class="fas fa-save"></i> Saqlash
        </button>
    </form>
</div>
{{end}}

{{define "extra_js"}}
<script>
    const LETTERS = 'ABCDEFGHIJ';
    const MAX_VARIANTS = 10;
    const MIN_VARIANTS = 2;

    function getVariantCount() {
        return document.querySelectorAll('#variantsList .variant-row').length;
    }

    function addVariant() {
        const count = getVariantCount();
        if (count >= MAX_VARIANTS) return;
        const letter = LETTERS[count];
        const list = document.getElementById('variantsList');
        const row = document.createElement('div');
        row.className = 'variant-row';
        row.dataset.index = count;
        row.innerHTML = '<span class="variant-row-letter">' + letter + '</span>' +
            '<input type="text" name="variant_' + letter.toLowerCase() + '" placeholder="' + letter + ' variantni kiriting">' +
            '<button type="button" class="btn btn-sm btn-remove-variant variant-remove-btn" onclick="removeVariant(this)" title="Olib tashlash"><i class="fas fa-minus"></i></button>';
        list.appendChild(row);
        updateCorrectOptions();
        updateRemoveButtons();
        if (getVariantCount() >= MAX_VARIANTS) {
            document.getElementById('btnAdd').style.display = 'none';
        }
    }

    function removeVariant(btn) {
        const row = btn.closest('.variant-row');
        row.remove();
        reindexVariants();
        updateCorrectOptions();
        updateRemoveButtons();
        document.getElementById('btnAdd').style.display = '';
    }

    function reindexVariants() {
        const rows = document.querySelectorAll('#variantsList .variant-row');
        rows.forEach((row, i) => {
            const letter = LETTERS[i];
            row.dataset.index = i;
            row.querySelector('.variant-row-letter').textContent = letter;
            const input = row.querySelector('input[type="text"]');
            input.name = 'variant_' + letter.toLowerCase();
        });
    }

    function updateCorrectOptions() {
        const sel = document.getElementById('correct_answer');
        const currentVal = sel.value;
        const count = getVariantCount();
        sel.innerHTML = '';
        for (let i = 0; i < count; i++) {
            const opt = document.createElement('option');
            opt.value = LETTERS[i];
            opt.textContent = LETTERS[i];
            sel.appendChild(opt);
        }
        if (currentVal && sel.querySelector('option[value="' + currentVal + '"]')) {
            sel.value = currentVal;
        }
    }

    function updateRemoveButtons() {
        const rows = document.querySelectorAll('#variantsList .variant-row');
        const canRemove = rows.length > MIN_VARIANTS;
        rows.forEach(row => {
            const btn = row.querySelector('.variant-remove-btn');
            if (btn) btn.style.display = canRemove ? '' : 'none';
        });
    }

    updateRemoveButtons();
    if (getVariantCount() >= MAX_VARIANTS) {
        document.getElementById('btnAdd').style.display = 'none';
    }
</script>
{{end}}
